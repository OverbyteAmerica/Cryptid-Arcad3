<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>DEFENDERS ‚Äî Lab 9: Predictive Defense Engine</title>
<style>
*,*::before,*::after{box-sizing:border-box;}
body{background-color:#000;color:#00ffcc;font-family:'Courier New',Courier,monospace;font-size:16px;line-height:1.4;margin:0;padding:20px;overflow-x:hidden;}
h1,h2,h3,h4{font-family:'Courier New',Courier,monospace;color:#00ffcc;margin:0 0 12px 0;}
h1{font-size:2rem;}h2{font-size:1.6rem;}h3{font-size:1.3rem;}
a{color:#00ffcc;text-decoration:none;}a:hover{text-decoration:underline;}
.hidden{display:none;}.center{text-align:center;}
.panel{border:1px solid #00ffcc;padding:18px;margin:20px 0;background-color:rgba(0,0,0,0.85);border-radius:6px;box-shadow:0 0 12px rgba(0,255,204,0.4);}
button{background-color:#000;border:1px solid #00ffcc;color:#00ffcc;padding:10px 16px;cursor:pointer;font-family:monospace;font-size:0.95rem;border-radius:4px;transition:all 0.2s ease;display:inline-block;}
button:hover{background-color:#002;box-shadow:0 0 8px #00ffcc;}
button:disabled{opacity:0.4;cursor:not-allowed;}
#cookie{position:fixed;top:20px;right:20px;width:240px;border:1px solid #00ffcc;background:#000;padding:12px;box-shadow:0 0 18px rgba(0,255,204,.5);font-size:0.9rem;z-index:9999;border-radius:8px;}
#cookie-avatar{font-size:1.6rem;margin-bottom:6px;}
#cookie-text{opacity:0.95;line-height:1.4;}
#cookie::before{content:"";position:absolute;inset:0;background:linear-gradient(rgba(0,255,204,0.05),transparent);pointer-events:none;}
.boot{font-size:1.1rem;margin-bottom:20px;white-space:pre-wrap;word-break:break-word;min-height:60px;}
.typing-cursor::after{content:"_";animation:blink 1s step-end infinite;}
@keyframes blink{from,to{opacity:0;}50%{opacity:1;}}
.log{background-color:#001;border:1px solid #00ffcc;padding:12px;margin-top:20px;height:220px;overflow-y:auto;font-size:0.85rem;border-radius:4px;box-shadow:0 0 10px rgba(0,255,204,0.3);}
.log p{margin:3px 0;}.warn{color:#ffaa00;}.danger{color:#ff4444;}.success{color:#00ffcc;}.info{color:#888;}
#pb-outer{background:rgba(0,255,204,0.1);border:1px solid #00ffcc44;border-radius:4px;height:8px;margin:10px 0 20px;overflow:hidden;}
#pb{height:100%;background:#00ffcc;width:0%;transition:width 0.5s ease;box-shadow:0 0 8px #00ffcc;}
/* model confidence bar */
#mc-outer{background:rgba(0,255,204,0.1);border:1px solid #00ffcc44;border-radius:4px;height:12px;margin:6px 0 4px;overflow:hidden;}
#mc-bar{height:100%;background:#ffaa00;width:80%;transition:width 0.6s ease;}
#mc-bar.high{background:#00ffcc;box-shadow:0 0 6px #00ffcc;}
#mc-bar.low{background:#ff4444;}
/* behavior timeline */
.beh-row{display:flex;align-items:center;gap:10px;padding:8px 12px;border:1px solid rgba(0,255,204,0.15);border-radius:3px;margin:5px 0;font-size:0.82rem;transition:border-color 0.3s;}
.beh-row.anomaly{border-color:#ff4444;background:rgba(255,68,68,0.04);}
.beh-row.flagged{border-color:#ffaa00;background:rgba(255,170,0,0.04);}
.beh-row.normal{border-color:rgba(0,255,204,0.15);}
.beh-time{min-width:70px;opacity:0.5;font-size:0.75rem;}
.beh-event{flex:1;}
.beh-badge{font-size:0.7rem;padding:2px 6px;border-radius:2px;}
.bb-norm{background:rgba(0,255,204,0.1);color:#00ffcc;border:1px solid #00ffcc44;}
.bb-anom{background:rgba(255,68,68,0.12);color:#ff4444;border:1px solid #ff444466;}
.bb-flag{background:rgba(255,170,0,0.12);color:#ffaa00;border:1px solid #ffaa0066;}
/* signal weight sliders */
.signal-row{display:flex;align-items:center;gap:12px;margin:10px 0;flex-wrap:wrap;}
.signal-row label{min-width:160px;font-size:0.82rem;opacity:0.8;}
.signal-row input[type=range]{flex:1;min-width:120px;accent-color:#00ffcc;}
.signal-row .signal-val{min-width:36px;text-align:right;font-size:0.82rem;color:#ffaa00;}
/* decision cards */
.dec-card{border:1px solid rgba(0,255,204,0.22);border-radius:4px;padding:14px;margin:8px 0;cursor:pointer;transition:all 0.2s;font-size:0.85rem;}
.dec-card:hover{background:rgba(0,255,204,0.03);border-color:#00ffcc55;}
.dec-card h4{margin:0 0 5px;font-size:0.88rem;}
.dec-card p{margin:0;opacity:0.65;font-size:0.8rem;line-height:1.5;}
.dec-card.chosen-right{border-color:#00ffcc;background:rgba(0,255,204,0.04);}
.dec-card.chosen-wrong{border-color:#ff4444;background:rgba(255,68,68,0.04);}
/* probability gauge */
.prob-gauge{background:#001;border:1px solid rgba(0,255,204,0.2);border-radius:4px;padding:14px;margin:10px 0;text-align:center;}
.prob-num{font-size:2.4rem;font-weight:bold;color:#ffaa00;transition:color 0.4s;}
.prob-num.danger-level{color:#ff4444;}
.prob-num.safe-level{color:#00ffcc;}
.prob-bar-wrap{background:rgba(0,255,204,0.08);border-radius:4px;height:16px;margin:8px 0;overflow:hidden;}
.prob-fill{height:100%;background:#ffaa00;transition:width 0.8s ease,background 0.4s ease;}
</style>
</head>
<body>

<div id="cookie"><div id="cookie-avatar">üêæ</div><div id="cookie-text">COOKIE v1.3 ‚Äî Lab 9 online. The model is training. It's been watching since Lab 1.</div></div>

<h1>DEFENDERS GUILD</h1>
<p style="opacity:0.6;margin:0 0 4px;">SEASON 1 ‚Äî PHASE 4: PREDICTIVE DEFENSE</p>
<h2>LAB 09 // PREDICTIVE DEFENSE ENGINE</h2>
<div id="pb-outer"><div id="pb"></div></div>

<div class="panel"><div class="boot typing-cursor" id="boot-text"></div></div>

<div class="panel">
  <h3>üìã MISSION BRIEF</h3>
  <p><strong>Skill Focus:</strong> Behavioral baselining ¬∑ Anomaly scoring ¬∑ Signal weighting ¬∑ Automated response thresholds</p>
  <p><strong>Role Alignment:</strong> SOC Tier 3 / Detection Architect</p>
  <p><strong>Story Context:</strong> The mole question from Lab 8 is unresolved ‚Äî but the Guild can't stop operating while the investigation runs. Instead, the decision was made to build something Darwin apparently designed years ago but never finished: a Predictive Defense Engine that builds behavioral baselines for every account and entity in the Vault, then scores deviations in real time to catch compromised accounts and insider threats before they act. You're finishing what Darwin started. And somewhere in the engine's training data is a pattern that points directly at who inside the Guild has been helping Asher.</p>
  <p><strong>Objectives:</strong> Establish behavioral baselines from historical data ¬∑ Review and flag behavioral anomalies ¬∑ Tune signal weights for the scoring model ¬∑ Set the automated response threshold and validate it</p>
</div>

<!-- MODEL CONFIDENCE -->
<div class="panel">
  <h3>MODEL CONFIDENCE</h3>
  <p style="opacity:0.7;font-size:0.85rem;">Measures how well the predictive model distinguishes legitimate behavior from threats. Builds as you feed it good decisions. Target: 90%+ before deployment.</p>
  <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;">
    <div style="flex:1;">
      <div style="display:flex;justify-content:space-between;font-size:0.8rem;opacity:0.6;margin-bottom:4px;"><span>MODEL CONFIDENCE</span><span id="mc-pct">80%</span></div>
      <div id="mc-outer"><div id="mc-bar"></div></div>
    </div>
    <span id="mc-label" style="color:#ffaa00;font-size:0.85rem;">‚ö† TRAINING ‚Äî Baseline incomplete</span>
  </div>
</div>

<!-- PHASE 1 ‚Äî BEHAVIORAL BASELINE -->
<div class="panel">
  <h3>PHASE 1 ‚Äî BEHAVIORAL BASELINE REVIEW</h3>
  <p style="opacity:0.7;font-size:0.85rem;">The engine has ingested 90 days of historical activity logs across all Vault accounts. It's generated a behavioral timeline for each one ‚Äî when they log in, where from, what they access, how long they stay. Your job is to review a flagged account's timeline and mark which events fall outside that account's established baseline. This is how the model learns what "suspicious" means for a specific person, not just in general.</p>
  <p style="opacity:0.6;font-size:0.82rem;margin-top:6px;border-left:2px solid #00ffcc44;padding-left:10px;">
    <strong style="color:#00ffcc;opacity:0.8;">HINT:</strong> A behavioral anomaly isn't just "unusual" ‚Äî it's a deviation from <em>this specific account's</em> established pattern. An admin who always logs in at 9am from a fixed IP is behaving normally. The same admin logging in at 3am from a new country is an anomaly for that account ‚Äî even if other accounts do it regularly. Context is everything.
  </p>
  <br>
  <button id="load-timeline-btn" onclick="loadTimeline()">‚ñ∂ LOAD BEHAVIORAL TIMELINE</button>
  <div id="timeline-wrap" class="hidden" style="margin-top:14px;"></div>
  <p id="baseline-status" style="margin-top:10px;font-size:0.85rem;color:#888;"></p>
</div>

<!-- PHASE 2 ‚Äî SIGNAL WEIGHTING -->
<div class="panel">
  <h3>PHASE 2 ‚Äî SIGNAL WEIGHT TUNING</h3>
  <p style="opacity:0.7;font-size:0.85rem;">The model scores threat probability by combining multiple signals ‚Äî each one gets a weight that determines how much it contributes to the final score. Weights that are too high create false positives. Too low and real threats don't score high enough to trigger a response. You need to tune four signals based on what you know about how Asher's attacks have actually worked across Labs 1‚Äì8.</p>
  <p style="opacity:0.6;font-size:0.82rem;margin-top:6px;border-left:2px solid #00ffcc44;padding-left:10px;">
    <strong style="color:#00ffcc;opacity:0.8;">HINT:</strong> Think back through the attack chain. Which signals actually preceded a real breach? Geographic anomaly appeared in Lab 5's phishing event. Off-hours logins appeared in Lab 6's credential abuse. New IP combined with failures appeared repeatedly. A single failed login, on the other hand, has appeared dozens of times in normal activity. Weight signals by how reliably they predicted real attacks, not just how dramatic they sound.
  </p>
  <div id="signal-wrap" style="margin-top:16px;"></div>
  <br>
  <button id="apply-weights-btn" onclick="applyWeights()">‚ñ∂ APPLY SIGNAL WEIGHTS</button>
  <p id="weights-status" style="margin-top:10px;font-size:0.85rem;"></p>
</div>

<!-- PHASE 3 ‚Äî LIVE SCORING -->
<div class="panel">
  <h3>PHASE 3 ‚Äî LIVE THREAT SCORING</h3>
  <p style="opacity:0.7;font-size:0.85rem;">The model is live. Four accounts have generated events in the last 30 minutes. The engine has scored each one for threat probability based on your signal weights. Review each score and decide: does this account need an immediate automated response, further investigation, or is it safe to dismiss? Your decisions train the model further.</p>
  <div id="scoring-wrap" style="margin-top:14px;"></div>
  <p id="scoring-status" style="margin-top:10px;font-size:0.85rem;color:#888;"></p>
</div>

<!-- PHASE 4 ‚Äî THRESHOLD & DEPLOYMENT -->
<div class="panel">
  <h3>PHASE 4 ‚Äî RESPONSE THRESHOLD &amp; DEPLOYMENT</h3>
  <p style="opacity:0.7;font-size:0.85rem;">The final step: set the probability threshold at which the engine automatically triggers a response ‚Äî and choose what that response is. Set it too low and every mildly unusual login becomes an incident. Too high and real attacks slip through. This is the hardest calibration in detection engineering: you're drawing a line that determines what the Vault treats as a threat.</p>
  <p style="opacity:0.6;font-size:0.82rem;margin-top:6px;border-left:2px solid #00ffcc44;padding-left:10px;">
    <strong style="color:#00ffcc;opacity:0.8;">HINT:</strong> Look at the scoring results from Phase 3. The real threats scored above 75%. The false positives landed between 30‚Äì55%. The gap between them tells you where to draw the line. You want to catch everything above the gap without triggering on everything below it.
  </p>
  <div id="threshold-wrap" style="margin-top:16px;"></div>
  <div id="response-options" style="margin-top:14px;"></div>
  <p id="threshold-status" style="margin-top:10px;font-size:0.85rem;"></p>
</div>

<div class="log" id="log">
  <p class="info">// LAB 9 INITIALIZED ‚Äî PREDICTIVE DEFENSE ENGINE LOADING</p>
  <p class="info">// 90-day behavioral baseline: INGESTED</p>
  <p class="info">// Flagged account: vault-admin-07 ‚Äî anomaly score ELEVATED</p>
</div>

<div class="panel hidden" id="complete-panel" style="box-shadow:0 0 24px rgba(0,255,204,0.6);">
  <h3 style="font-size:1.4rem;">‚úÖ LAB 9 COMPLETE ‚Äî PREDICTIVE ENGINE DEPLOYED</h3>
  <p>Baseline established. Signals tuned. Threshold set. Engine is live across all Vault accounts.</p>
  <p style="color:#888;font-size:0.85rem;">Within 4 minutes of deployment, the engine flagged something the manual detection layer had missed entirely: vault-admin-07 scored 94% threat probability based on a pattern of access to Darwin's archived file directories ‚Äî late at night, from an IP that first appeared the same week Asher began the Byte Bug campaign. That account belongs to a senior Guild analyst. The engine just identified your mole. What happens next isn't a lab. It's a decision the Guild has to make.</p>
  <p><strong>SKILLS EARNED:</strong> Behavioral Baselining ¬∑ Anomaly Detection ¬∑ Signal Weighting ¬∑ Automated Response Thresholds</p>
  <p><strong>CAREER RELEVANCE:</strong> SOC Tier 3 ¬∑ Detection Architect ¬∑ Threat Intelligence Lead</p>
  <br>
  <div style="display:flex;gap:14px;flex-wrap:wrap;margin-top:8px;">
    <a href="s1-lab10.html"><button>‚Üí PROCEED TO LAB 10: SEASON FINALE</button></a>
    <a href="defenders-dashboard.html"><button style="border-color:#555;color:#888;">‚åÇ BACK TO DASHBOARD</button></a>
  </div>
</div>

<script>
const narrative=`> DEFENDERS GUILD ‚Äî BOOTLOADER v1.0\n> Predictive Defense Engine: INITIALIZING\n> Training data: 90-day behavioral corpus ‚Äî 847 accounts\n> Flagged anomaly: vault-admin-07 ‚Äî deviation score 4.2œÉ\n> Darwin's original model architecture: DETECTED in legacy partition\n> Defender ‚Äî finish what Darwin started.`;
let ci=0;const be=document.getElementById('boot-text');
function typeIt(){if(ci<narrative.length){be.textContent+=narrative[ci++];setTimeout(typeIt,28);}else{be.classList.remove('typing-cursor');initLab();}}
typeIt();

// MODEL CONFIDENCE
let mc=80;
function setMC(v){
  mc=Math.max(0,Math.min(100,v));
  document.getElementById('mc-pct').textContent=mc+'%';
  document.getElementById('mc-bar').style.width=mc+'%';
  const bar=document.getElementById('mc-bar'),lbl=document.getElementById('mc-label');
  bar.classList.remove('high','low');
  if(mc>=90){bar.classList.add('high');lbl.style.color='#00ffcc';lbl.textContent='‚úì HIGH CONFIDENCE ‚Äî Model ready for deployment';}
  else if(mc>=70){lbl.style.color='#ffaa00';lbl.textContent='‚ö† TRAINING ‚Äî Baseline incomplete';}
  else{bar.classList.add('low');lbl.style.color='#ff4444';lbl.textContent='‚ö† LOW CONFIDENCE ‚Äî Model unreliable';}
}

const phases={p1:false,p2:false,p3:false,p4:false};
function updatePB(){const d=Object.values(phases).filter(Boolean).length;document.getElementById('pb').style.width=(d/4*100)+'%';if(d===4)setTimeout(showComplete,600);}
function lg(m,c=''){const l=document.getElementById('log');const p=document.createElement('p');if(c)p.className=c;p.textContent=m;l.appendChild(p);l.scrollTop=l.scrollHeight;}
function cookie(m){document.getElementById('cookie-text').textContent=m;}

function initLab(){
  buildSignals();
  buildScoring();
  buildThreshold();
  cookie('vault-admin-07 has been flagged. Load the timeline and see what the baseline shows.');
}

// PHASE 1 ‚Äî TIMELINE
const timelineEvents=[
  {time:'MON 08:52',event:'Login ‚Äî vault-admin-07 ‚Äî 10.0.0.55 (known IP) ‚Äî US region',type:'normal',shouldFlag:false},
  {time:'MON 09:14',event:'File access ‚Äî /ops/reports/q3-audit.pdf ‚Äî expected for role',type:'normal',shouldFlag:false},
  {time:'TUE 09:01',event:'Login ‚Äî vault-admin-07 ‚Äî 10.0.0.55 ‚Äî US region',type:'normal',shouldFlag:false},
  {time:'WED 02:47',event:'Login ‚Äî vault-admin-07 ‚Äî 185.220.101.47 (NEW IP) ‚Äî Eastern Europe',type:'anomaly',shouldFlag:true},
  {time:'WED 02:49',event:'Directory access ‚Äî /archive/darwin_research/ ‚Äî 14 files opened',type:'anomaly',shouldFlag:true},
  {time:'WED 02:58',event:'Outbound transfer ‚Äî 3.2MB ‚Äî destination: external relay',type:'anomaly',shouldFlag:true},
  {time:'THU 08:55',event:'Login ‚Äî vault-admin-07 ‚Äî 10.0.0.55 ‚Äî US region ‚Äî normal pattern resumed',type:'normal',shouldFlag:false},
  {time:'FRI 23:31',event:'Login ‚Äî vault-admin-07 ‚Äî 185.220.101.47 ‚Äî Eastern Europe ‚Äî same new IP',type:'anomaly',shouldFlag:true},
  {time:'FRI 23:33',event:'Access ‚Äî /archive/darwin_research/key_fragments/ ‚Äî attempted, access denied',type:'anomaly',shouldFlag:true},
];
let tlTagged={},tlDone=false;
function loadTimeline(){
  document.getElementById('load-timeline-btn').disabled=true;
  lg('> Loading 90-day behavioral timeline for vault-admin-07...');
  cookie('Normal pattern: weekday logins, 08:50‚Äì09:15, fixed US IP. Anything outside that window is worth flagging.');
  const wrap=document.getElementById('timeline-wrap');
  wrap.classList.remove('hidden');
  wrap.innerHTML='<p style="font-size:0.78rem;opacity:0.6;margin-bottom:8px;">Click each event to FLAG (anomaly) or CLEAR (normal activity):</p>';
  timelineEvents.forEach((e,i)=>{
    const d=document.createElement('div');
    d.className='beh-row '+e.type;d.id='tl'+i;
    d.innerHTML=`<span class="beh-time">${e.time}</span>
    <span class="beh-event">${e.event}</span>
    <div style="display:flex;gap:5px;">
      <button style="font-size:0.75rem;padding:4px 8px;border-color:#ff4444;color:#ff4444;" onclick="tagEvent(${i},'flag',this)">FLAG</button>
      <button style="font-size:0.75rem;padding:4px 8px;border-color:#555;color:#666;" onclick="tagEvent(${i},'clear',this)">CLEAR</button>
    </div>`;
    wrap.appendChild(d);
    setTimeout(()=>d.style.opacity='1',i*120);
  });
}
function tagEvent(i,decision,btn){
  if(tlTagged[i])return;
  tlTagged[i]=decision;
  const e=timelineEvents[i];
  const row=document.getElementById('tl'+i);
  row.querySelectorAll('button').forEach(b=>b.disabled=true);
  const correct=(decision==='flag')===e.shouldFlag;
  row.classList.remove('normal','anomaly');
  row.classList.add(correct?(decision==='flag'?'anomaly':'normal'):(decision==='flag'?'flagged':'anomaly'));
  setMC(mc+(correct?2:-4));
  lg(`> ${correct?'Correct':'Incorrect'}: ${e.time} ‚Äî ${decision==='flag'?'flagged as anomaly':'cleared as normal'}`,(correct?'success':'warn'));
  if(Object.keys(tlTagged).length===timelineEvents.length&&!tlDone){
    tlDone=true;
    const score=timelineEvents.filter((e,i)=>(tlTagged[i]==='flag')===e.shouldFlag).length;
    setTimeout(()=>{
      const st=document.getElementById('baseline-status');
      if(score>=7){
        st.innerHTML=`<span style="color:#00ffcc;">‚úì ${score}/9 correctly tagged. Baseline established. Phase 1 complete.</span>`;
        phases.p1=true;updatePB();
        cookie('Good reads. The Wednesday and Friday late-night sessions from that Eastern European IP are the core anomaly. Darwin\'s archive was the target.');
        lg('> Phase 1 complete. Behavioral baseline confirmed.','success');
      } else {
        st.innerHTML=`<span style="color:#ffaa00;">‚ö† ${score}/9 correct. Focus on time-of-day, source IP, and which directories were accessed. Normal behavior for this account is very consistent.</span>`;
        setMC(mc-4);
      }
    },400);
  }
}

// PHASE 2 ‚Äî SIGNAL WEIGHTS
const signals=[
  {id:'s1',label:'Geographic anomaly (new country/region)',recommended:9,explanation:'Strong predictor ‚Äî appeared in every real breach across Labs 5‚Äì8.'},
  {id:'s2',label:'Off-hours access (outside established window)',recommended:8,explanation:'High value ‚Äî attackers operate when analysts aren\'t watching.'},
  {id:'s3',label:'Single failed login',recommended:2,explanation:'Very low value alone ‚Äî appears constantly in normal activity.'},
  {id:'s4',label:'New source IP (first-seen address)',recommended:7,explanation:'Meaningful in combination ‚Äî flags unfamiliar access points.'},
  {id:'s5',label:'Access to sensitive archive directories',recommended:9,explanation:'Critical signal ‚Äî Darwin\'s directories accessed by the mole in Phase 1.'},
  {id:'s6',label:'Outbound transfer to unknown destination',recommended:8,explanation:'Strong exfiltration indicator ‚Äî seen in Labs 2, 3, and 7.'},
];
function buildSignals(){
  const wrap=document.getElementById('signal-wrap');
  signals.forEach(s=>{
    const d=document.createElement('div');d.className='signal-row';
    d.innerHTML=`<label>${s.label}</label>
    <input type="range" id="${s.id}" min="1" max="10" value="5" oninput="document.getElementById('sv-${s.id}').textContent=this.value">
    <span class="signal-val" id="sv-${s.id}">5</span><span style="font-size:0.72rem;opacity:0.4;">/10</span>`;
    wrap.appendChild(d);
  });
}
let weightsDone=false;
function applyWeights(){
  if(weightsDone)return;
  document.getElementById('apply-weights-btn').disabled=true;
  const vals={};signals.forEach(s=>{vals[s.id]=parseInt(document.getElementById(s.id).value);});
  const score=signals.reduce((acc,s)=>{
    const diff=Math.abs(vals[s.id]-s.recommended);
    return acc+(diff<=1?3:diff<=2?1:-1);
  },0);
  const maxScore=signals.length*3;
  const pct=Math.round(score/maxScore*100);
  lg('> Applying signal weights to model...');
  setTimeout(()=>{
    const st=document.getElementById('weights-status');
    if(pct>=60){
      weightsDone=true;
      st.innerHTML=`<span style="color:#00ffcc;">‚úì Signal weights applied. Model calibration: ${pct}% optimal. Phase 2 complete.</span>`;
      phases.p2=true;updatePB();setMC(mc+5);
      cookie('Solid calibration. High weight on geographic anomaly and archive access ‚Äî that\'s exactly what the real attacks showed.');
      lg('> Phase 2 complete. Signal weights calibrated.','success');
      signals.forEach(s=>{
        const diff=Math.abs(vals[s.id]-s.recommended);
        if(diff>2)lg(`> Note: "${s.label}" ‚Äî recommended weight ${s.recommended}, you set ${vals[s.id]}. ${s.explanation}`,'warn');
      });
    } else {
      st.innerHTML=`<span style="color:#ffaa00;">‚ö† Model calibration: ${pct}% optimal. Review which signals actually predicted real attacks. ${signals.filter(s=>Math.abs(vals[s.id]-s.recommended)>2).map(s=>s.label).join(', ')} may need adjustment.</span>`;
      setMC(mc-4);
      document.getElementById('apply-weights-btn').disabled=false;
      cookie('The model calibration is off. Think about which signals showed up consistently in real breaches versus background noise.');
    }
  },1200);
}

// PHASE 3 ‚Äî LIVE SCORING
const scoringAccounts=[
  {
    name:'vault-admin-07',
    events:'Login 02:31 from 185.220.101.47 (Eastern Europe) + access to /archive/darwin_research/',
    probability:94,
    correct:'respond',
    feedback:'94% threat probability. Two of the highest-weighted signals in combination ‚Äî geographic anomaly plus sensitive archive access, at 2:31am. This is the mole. Automated response is correct.'
  },
  {
    name:'dev-user-12',
    events:'Login 09:15 from known IP + single failed login attempt at 09:14',
    probability:12,
    correct:'dismiss',
    feedback:'12% ‚Äî one typo before a normal login from a known IP during business hours. This is background noise. Responding here creates false positives that erode trust in the system.'
  },
  {
    name:'svc-monitor-02',
    events:'Login 03:00 from known service IP ‚Äî automated monitoring job ‚Äî consistent nightly pattern',
    probability:8,
    correct:'dismiss',
    feedback:'8% ‚Äî a scheduled service job running at its normal time from its normal IP. The model correctly scores this very low. Dismissing is right.'
  },
  {
    name:'analyst-rosa',
    events:'Login 23:41 from new IP (hotel WiFi, travel logged in HR system) + access to standard ops files',
    probability:41,
    correct:'investigate',
    feedback:'41% ‚Äî the new IP and late login are flagged but the travel is documented and access is normal for her role. Not high enough to auto-respond, but worth a follow-up to confirm it\'s really her.'
  },
];
let scoringAnswers={},scoringDone=false;
function buildScoring(){
  const wrap=document.getElementById('scoring-wrap');
  scoringAccounts.forEach((a,i)=>{
    const probColor=a.probability>=75?'#ff4444':a.probability>=40?'#ffaa00':'#00ffcc';
    const d=document.createElement('div');
    d.style.cssText='border:1px solid rgba(0,255,204,0.2);border-radius:4px;padding:14px;margin:10px 0;';
    d.id='sc'+i;
    d.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:10px;margin-bottom:10px;">
      <div><strong>${a.name}</strong><div style="font-size:0.78rem;opacity:0.6;margin-top:3px;">${a.events}</div></div>
      <div class="prob-gauge" style="min-width:120px;padding:8px 14px;">
        <div class="prob-num" style="font-size:1.6rem;color:${probColor};">${a.probability}%</div>
        <div class="prob-bar-wrap"><div class="prob-fill" style="width:${a.probability}%;background:${probColor};"></div></div>
        <div style="font-size:0.7rem;opacity:0.5;">threat probability</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button style="font-size:0.8rem;padding:6px 12px;border-color:#ff4444;color:#ff4444;" onclick="scoreDecision(${i},'respond',this)">‚ö° AUTO-RESPOND</button>
      <button style="font-size:0.8rem;padding:6px 12px;border-color:#ffaa00;color:#ffaa00;" onclick="scoreDecision(${i},'investigate',this)">üîç INVESTIGATE</button>
      <button style="font-size:0.8rem;padding:6px 12px;border-color:#555;color:#666;" onclick="scoreDecision(${i},'dismiss',this)">‚Äî DISMISS</button>
    </div>
    <p id="scfb${i}" style="font-size:0.8rem;margin-top:8px;"></p>`;
    wrap.appendChild(d);
  });
}
function scoreDecision(i,choice,btn){
  if(scoringAnswers[i])return;
  scoringAnswers[i]=choice;
  const a=scoringAccounts[i];
  const el=document.getElementById('sc'+i);
  el.querySelectorAll('button').forEach(b=>b.disabled=true);
  const correct=choice===a.correct;
  el.style.borderColor=correct?'#00ffcc':'#ff4444';
  document.getElementById('scfb'+i).innerHTML=`<span style="color:${correct?'#00ffcc':'#ffaa00'};">${correct?'‚úì':'‚ö†'} ${a.feedback}</span>`;
  setMC(mc+(correct?3:-4));
  lg(`> Scoring decision ${correct?'correct':'incorrect'}: ${a.name} ‚Äî ${choice}`,(correct?'success':'warn'));
  if(Object.keys(scoringAnswers).length===scoringAccounts.length&&!scoringDone){
    scoringDone=true;
    const score=scoringAccounts.filter((a,i)=>scoringAnswers[i]===a.correct).length;
    setTimeout(()=>{
      const st=document.getElementById('scoring-status');
      if(score>=3){
        st.innerHTML=`<span style="color:#00ffcc;">‚úì ${score}/4 correct. Scoring calibrated. Phase 3 complete.</span>`;
        phases.p3=true;updatePB();
        cookie('vault-admin-07 at 94% and the low-scorers dismissed cleanly. The model is working. Time to set the deployment threshold.');
        lg('> Phase 3 complete. Live scoring validated.','success');
      } else {
        st.innerHTML=`<span style="color:#ffaa00;">‚ö† ${score}/4 correct. The gap between 94% and 41% is significant ‚Äî use probability as a guide, not just instinct.</span>`;
        setMC(mc-3);
      }
    },400);
  }
}

// PHASE 4 ‚Äî THRESHOLD
let thresholdSet=false,responsePicked=false;
function buildThreshold(){
  const wrap=document.getElementById('threshold-wrap');
  wrap.innerHTML=`<p style="font-size:0.82rem;opacity:0.8;margin-bottom:10px;">Set the probability threshold for automatic response:</p>
  <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap;">
    <input type="range" id="thresh-slider" min="40" max="95" value="70" oninput="updateThreshPreview(this.value)" style="flex:1;min-width:160px;accent-color:#00ffcc;">
    <span id="thresh-display" style="font-size:1.4rem;color:#ffaa00;min-width:60px;">70%</span>
  </div>
  <div id="thresh-preview" style="margin-top:10px;font-size:0.82rem;opacity:0.7;"></div>
  <br><button id="set-thresh-btn" onclick="setThreshold()">‚ñ∂ CONFIRM THRESHOLD</button>`;
  updateThreshPreview(70);

  const ropts=document.getElementById('response-options');
  ropts.innerHTML='<p style="font-size:0.82rem;opacity:0.8;margin:14px 0 8px;">When threshold is exceeded, the engine should:</p>';
  const responses=[
    {title:'SOFT LOCK + CAPTURE + NOTIFY SOC',detail:'Restrict account to read-only, snapshot session state for evidence, page on-call analyst. Human makes final lockout decision.',correct:true,feedback:'Correct. Proportional, evidence-preserving, human-in-the-loop. The same principle from Lab 6 ‚Äî limit damage without handing the attacker a denial-of-service weapon against your own system.'},
    {title:'IMMEDIATE FULL ACCOUNT LOCKOUT',detail:'Hard lock across all systems instantly, no human review.',correct:false,feedback:'Too aggressive for automated action ‚Äî an attacker who knows your threshold can trigger lockouts on legitimate accounts deliberately. Reserve full lockout for human-confirmed decisions.'},
    {title:'ALERT ONLY ‚Äî NO AUTOMATED ACTION',detail:'Send a high-priority alert and wait for analyst response.',correct:false,feedback:'Too slow for a 94% threat probability score. By the time an analyst acts on an alert, a motivated insider can complete an exfiltration in under 3 minutes.'},
  ];
  responses.forEach((r,i)=>{
    const d=document.createElement('div');d.className='dec-card';
    d.innerHTML=`<h4>${r.title}</h4><p>${r.detail}</p>`;
    d.onclick=()=>pickResponse(i,d,r);
    ropts.appendChild(d);
  });
}
function updateThreshPreview(val){
  document.getElementById('thresh-display').textContent=val+'%';
  const v=parseInt(val);
  let preview='';
  if(v<60)preview='‚ö† Very low ‚Äî most unusual activity will trigger a response. Expect high false positive rate.';
  else if(v<70)preview='‚ö† Low ‚Äî catches most threats but will generate noise on borderline cases like analyst-rosa (41%).';
  else if(v<=80)preview='‚úì Good range ‚Äî sits in the gap between borderline cases (~41%) and confirmed threats (~94%). Recommended.';
  else if(v<=88)preview='‚ö† High ‚Äî may miss emerging threats that haven\'t yet scored above the threshold.';
  else preview='‚ö† Very high ‚Äî only the most obvious threats will trigger. Low-and-slow attacks will pass under this ceiling.';
  document.getElementById('thresh-preview').textContent=preview;
  document.getElementById('thresh-display').style.color=v>=70&&v<=80?'#00ffcc':'#ffaa00';
}
function setThreshold(){
  const val=parseInt(document.getElementById('thresh-slider').value);
  document.getElementById('set-thresh-btn').disabled=true;
  document.getElementById('thresh-slider').disabled=true;
  const st=document.getElementById('threshold-status');
  if(val>=65&&val<=82){
    thresholdSet=true;
    lg(`> Response threshold set: ${val}%`,'success');
    setMC(mc+4);
    st.innerHTML=`<span style="color:#00ffcc;">‚úì Threshold set at ${val}%. Sits cleanly between borderline (41%) and confirmed threat (94%) scores. Now select the automated response.</span>`;
    cookie(`Threshold at ${val}% ‚Äî that gap between 41% and 94% is your safety margin. Now pick what the engine does when it fires.`);
  } else if(val<65){
    st.innerHTML=`<span style="color:#ffaa00;">‚ö† ${val}% is too low ‚Äî analyst-rosa's 41% travel login would trigger a response. Raise the threshold above the false positive range.</span>`;
    setMC(mc-3);
    document.getElementById('set-thresh-btn').disabled=false;
    document.getElementById('thresh-slider').disabled=false;
  } else {
    st.innerHTML=`<span style="color:#ffaa00;">‚ö† ${val}% is too high ‚Äî emerging threats that build gradually may never reach this ceiling. The mole scored 94% but a less obvious insider might score 78%. Lower the threshold.</span>`;
    setMC(mc-3);
    document.getElementById('set-thresh-btn').disabled=false;
    document.getElementById('thresh-slider').disabled=false;
  }
}
let responseDone=false;
function pickResponse(i,el,r){
  if(responseDone||!thresholdSet)return;
  document.querySelectorAll('#response-options .dec-card').forEach(c=>{c.onclick=null;c.style.cursor='default';});
  const st=document.getElementById('threshold-status');
  if(r.correct){
    responseDone=true;
    el.classList.add('chosen-right');
    const finalMC=Math.min(100,mc+5);
    setMC(finalMC);
    st.innerHTML=`<span style="color:#00ffcc;">‚úì ${r.feedback} Engine deployed. Phase 4 complete.</span>`;
    phases.p4=true;updatePB();
    lg('> Automated response configured. Predictive Defense Engine deployed.','success');
    cookie('Engine is live. vault-admin-07 just logged in. Score: 94%. The response is already running.');
  } else {
    el.classList.add('chosen-wrong');
    st.innerHTML+=`<br><span style="color:#ffaa00;">‚ö† ${r.feedback}</span>`;
    setMC(mc-4);
    lg('> Response strategy rejected ‚Äî review proportional response principles','warn');
    setTimeout(()=>{
      el.classList.remove('chosen-wrong');
      document.querySelectorAll('#response-options .dec-card').forEach((c,ci)=>{
        const opts=[{correct:true},{correct:false},{correct:false}];
        if(!c.classList.contains('chosen-right')){c.onclick=()=>pickResponse(ci,c,[
          {title:'',correct:true,feedback:'Correct. Proportional, evidence-preserving, human-in-the-loop. The same principle from Lab 6 ‚Äî limit damage without handing the attacker a denial-of-service weapon against your own system.'},
          {title:'',correct:false,feedback:'Too aggressive for automated action ‚Äî an attacker who knows your threshold can trigger lockouts on legitimate accounts deliberately. Reserve full lockout for human-confirmed decisions.'},
          {title:'',correct:false,feedback:'Too slow for a 94% threat probability score. By the time an analyst acts on an alert, a motivated insider can complete an exfiltration in under 3 minutes.'},
        ][ci]);c.style.cursor='pointer';}
      });
    },1200);
  }
}

function showComplete(){
  document.getElementById('complete-panel').classList.remove('hidden');
  document.getElementById('complete-panel').scrollIntoView({behavior:'smooth'});
  lg('>>> LAB 9 COMPLETE. PREDICTIVE ENGINE DEPLOYED. MOLE IDENTIFIED. <<<','success');
  cookie('The engine found what nine labs of manual work couldn\'t. vault-admin-07. The mole is real. Lab 10 is the endgame.');
}
</script>
</body>
</html>
